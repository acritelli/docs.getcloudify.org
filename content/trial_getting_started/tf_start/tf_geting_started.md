+++

title = "Create Blueprint from Terraform module"
description = "Terraform-based Blueprints - Creating a blueprint from a Terraform module, including deployment and installation of the environment."
weight = 27
alwaysopen = false
+++

This getting started guide introduces you to creating a blueprint from a Terraform module. You will also deploy and install the environment.

## Prerequisites
* {{< param cfy_manager_name >}} Version 6.4 or later
* Terraform module archive available from a URL or local zip file
* Credentials to a cloud provider, such as AWS


## Overview
In this guide we will perform the following steps to create a blueprint from a Terraform module and test it:

* Prepare the manager by defining secrets that contain cloud credentials
* Provide a URL to the Terraform archive and chose the right module
* Define the Terraform variables for the module
* Define the environment variables for the Terraform execution
* Define the outputs and capabilities of the blueprint
* Create a deployment to test the created blueprint


## Step 1: Define Credential Secrets

In this step we will define secrets for the cloud, such as AWS, that you would like to use. The secrets, such as an AWS Access Key ID and Secret Access Key, are defined on the Secrets page under the Resources section in the sidebar menu.

In this example we will use an AWS account and define the following secrets:

* `aws_access_key_id` - AWS access key id
* `aws_secret_access_key`  - AWS access key secret
* `root_ssh_key` - ssh private key

![Define Secrets]( /images/trial_getting_started/tf/DefineSecrets.jpg )

## Step 2: Open the Upload dialog and define the blueprint name.

Next, we will open the Upload dialog for Terraform modules. Navigate to the Blueprints page and select the "Upload" dropdown. Select the "Upload from Terraform module" option.

This will launch the "Create blueprint from Terraform" dialog. Provide the following initial information:

* **Blueprint name:** Provide a name for your Blueprint. This will appear in the Blueprint catalog.
* **Blueprint description:** Provide an optional description for your Blueprint. This will also appear in the Blueprint catalog to provide extra context for the Blueprint.
* **Terraform version:** Select the version of Terraform that you want the Blueprint to use.

## Step 3: Upload the Terraform archive and select the module

Next, we will provide Cloudify with the location of the Terraform module. Terraform modules can be provided as ZIP archives from a remote URL (such as an artifact server) or from a local ZIP file uploaded to the {{< param cfy_manager_name >}}. This example will use a URL for the ZIP archive.

There are a few things that you should know about the structure of Terraform module ZIP archives:

* The folder structure of the archive should start with a single root folder. This root folder can contain the Terraform module or subfolders with multiple modules.
* It is possible to use archive URLs that are generated by services like Github (as we do in this example).
* For archives that contain multiple modules, you are able to choose the module you need by selecting the path in the dropdown.

In this example, we will use an example module from the [Cloudify Community GitHub repository](https://github.com/cloudify-community/tf-source). Provide the following information under the "Terraform module details" section:

* **Terraform module source:** Provide the following URL to the Cloudify Community example: https://github.com/cloudify-community/tf-source/archive/refs/heads/main.zip
* **Terraform module folder:** Select `tf-source-main/template/modules/public_vm` from the dropdown menu.

A dialog will pop up on the screen and ask you if you want to automatically define detected variables and outputs. Click "Yes" on this dialog.


TODO: update image below

![Define Terraform Module Path]( /images/trial_getting_started/tf/Tf_Path.jpg )


## Step 4: Define the variables for the Terraform module

Cloudify 6.4 includes the ability to automatically detect Variables and Outputs for Terraform modules. Once the Variables have been automatically detected, you can fine-tune how those Variables are exposed in the Blueprint.

* Open the variables section and click the ‘Add’ button
* Type the variable name
* Select the source type and a value / input name / secret name
  * Static value - A Value  that will always be assigned to the variable
  * Input  - the variable that will be set by an input that will be presented when a deployment is created.
  * Secret - The value assigned to the variable that will be taken from the secret store.

If the Terraform module dose not have credentials set as variables, see below title "Using modules from Registry, Passing provider credentials by defining the Environment Variables"
In our example we will map the variables to the secrets with the account AWS credentials

# TODO: Update image below

![Define Terraform Module Outputs]( /images/trial_getting_started/tf/Variables.jpg )


## Step 5 Define the outputs and capabilities of the blueprint
The outputs of the Terraform module can be made available in the outputs and capabilities in Cloudify.

When to use output and when to use a capability:

* Define outputs to display information to the user or export to other system
* Define capabilities for information you would like to make available for other deployments and service composition.

![Define Terraform Module Outputs]( /images/trial_getting_started/tf/Outputs.jpg )


## Step 6 Create the blueprint
Submit the dialog, errors discovered will appear in the dialog. After successful submission you will be forwarded to the blueprint page.

## Step 7 Create a Deployment and Test the blueprint
* Click the ‘create deployment’ button.
* Review the logs, located in the logs section of the deployment page
* Review deployment output
* Review the inputs in the Deployment Creation dialog
* Inspect the install workflow execution graph until it will finished, The bars of the execution graph will turn green when operations will finish.
* Review the logs section of the deployment's page
* Click the Deployment info tab and review the outputs section, There you will find the outputs of the terraform module defined in the blueprint

![Terraform Marketplace]( /images/trial_getting_started/tf/TfInstall.jpg )


## Using modules from Registry, Passing provider credentials by defining the Environment Variables
Some Terraform modules, like those downloaded from the registry, rely on environment variables to supply credentials and other information to the providers needed. You can define the environment variable and assign it with values in the ‘environment variables’ section - as per configured in the variable section. The current blueprint we are creating gets credentials from the variables, while we examine an example Environment Variables section:
AWS Example:

* Environment Variable: AWS_ACCESS_KEY_ID  Type: Secret  Secret's Name: aws_access_key_id
* Environment Variable: AWS_SECRET_ACCESS_KEY Type: Secret  Secret's Name: aws_secret_access_key
* Environment Variable: AWS_DEFAULT_REGION Type: static Value: us-west-2

## Troubleshooting

* The credentials were defined in the variables section instead of the environment variables section
 * Error: Value for undeclared variableThe root module does not declare a variable named "AWS_ACCESS_KEY_ID" but a value was found in…
* The Version of terraform selected was too old for the terraform module you have uploaded.
 * Error: Could not load pluginPlugin reinitialization required. Please run "terraform init".
* Credentials were not defined.
 * Error: configuring Terraform AWS Provider: no valid credential sources for Terraform AWS Provider found.
